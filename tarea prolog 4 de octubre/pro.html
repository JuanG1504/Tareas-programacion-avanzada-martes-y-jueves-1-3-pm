<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Inscripción de Curso</title>
  <script src="core.js"></script>
  <script src="lists.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 30px; }
    select, button { margin: 10px 0; padding: 8px; font-size: 14px; }
    .card { border: 1px solid #ccc; padding: 15px; margin-top: 20px; border-radius: 5px; }
    .success { background-color: #d4edda; color: #155724; }
    .error { background-color: #f8d7da; color: #721c24; }
    .info { background-color: #fff3cd; color: #856404; }
    ul { margin: 5px 0 0 20px; }
  </style>
</head>
<body>
  <h1>Verificar inscripción de curso</h1>

  <label for="alumno">Selecciona un alumno:</label>
  <select id="alumno">
    <option value="juan">Juan</option>
    <option value="maria">María</option>
    <option value="pedro">Pedro</option>
    <option value="ana">Ana</option>
    <option value="luis">Luis</option>
  </select>
  <br>

  <label for="curso">Selecciona un curso:</label>
  <select id="curso">
    <option value="matematicas">Matemáticas</option>
    <option value="calculo">Cálculo</option>
    <option value="programacion">Programación</option>
    <option value="programacion2">Programación 2</option>
    <option value="bases_datos">Bases de Datos</option>
    <option value="ia">Inteligencia Artificial</option>
  </select>
  <br>

  <button onclick="verificarInscripcion()">Verificar inscripción</button>

  <div id="resultado"></div>

  <script>
    const program = `
      % Cursos
      curso(matematicas).
      curso(calculo).
      curso(programacion).
      curso(programacion2).
      curso(bases_datos).
      curso(ia).

      % Prerequisitos
      prerequisito(calculo, matematicas).
      prerequisito(programacion2, programacion).
      prerequisito(bases_datos, programacion).
      prerequisito(ia, bases_datos).
      prerequisito(ia, programacion2).

      % Alumnos y cursos aprobados
      aprobado(juan, matematicas).
      aprobado(juan, programacion).

      aprobado(maria, matematicas).
      aprobado(maria, calculo).

      aprobado(pedro, matematicas).
      aprobado(pedro, calculo).
      aprobado(pedro, programacion).
      aprobado(pedro, programacion2).

      aprobado(ana, matematicas).

      aprobado(luis, matematicas).
      aprobado(luis, programacion).
      aprobado(luis, programacion2).
      aprobado(luis, bases_datos).

      % Puede cursar
      puede_cursar(Alumno, Curso) :-
          curso(Curso),
          \\+ aprobado(Alumno, Curso),
          \\+ (prerequisito(Curso, Req), \\+ aprobado(Alumno, Req)).

      % Faltan prerequisitos
      prerequisitos_faltantes(Alumno, Curso, Lista) :-
          findall(Req, (prerequisito(Curso, Req), \\+ aprobado(Alumno, Req)), Raw),
          sort(Raw, Lista).

      % Verificar si ya aprobó
      ya_aprobo(Alumno, Curso) :- aprobado(Alumno, Curso).
    `;

    const session = pl.create();
    session.consult(program, {
      success: () => console.log("KB cargada"),
      error: (err) => console.error("Error KB:", err)
    });

    function ejecutarConsulta(consulta, callback) {
      session.query(consulta, {
        success: () => {
          session.answer(answer => {
            if (answer === false) callback([]);
            else {
              const formatted = session.format_answer(answer);
              const match = formatted.match(/\[(.*)\]/);
              if (match) {
                const list = match[1].split(",").map(s => s.trim()).filter(s => s.length > 0);
                callback(list);
              } else {
                callback([]);
              }
            }
          });
        },
        error: err => { console.error("Error en consulta:", err); callback([]); }
      });
    }

    function verificarInscripcion() {
      const alumno = document.getElementById("alumno").value;
      const curso = document.getElementById("curso").value;
      const resultado = document.getElementById("resultado");

  
      session.query(`ya_aprobo(${alumno}, ${curso}).`);
      session.answer(answer => {
        if (answer !== false) {
          resultado.innerHTML = `
            <div class="card info">
               ${alumno} ya completó el curso ${curso}.
            </div>
          `;
        } else {
         
          session.query(`puede_cursar(${alumno}, ${curso}).`);
          session.answer(ans => {
            if (ans !== false) {
              resultado.innerHTML = `
                <div class="card success">
                   ${alumno} puede inscribirse en ${curso}.
                </div>
              `;
            } else {
             
              ejecutarConsulta(`prerequisitos_faltantes(${alumno}, ${curso}, Lista).`, faltantes => {
                resultado.innerHTML = `
                  <div class="card error">
                     ${alumno} no puede inscribirse en ${curso}.
                    <br>Le faltan los siguientes prerequisitos:
                    <ul>${faltantes.map(c => `<li>${c}</li>`).join('')}</ul>
                  </div>
                `;
              });
            }
          });
        }
      });
    }
  </script>
</body>
</html>
